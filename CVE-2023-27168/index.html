<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="generator" content="mkdocs-1.5.3, mkdocs-terminal-4.4.0">
     
     
    
    <link rel="canonical" href="https://balwurk.github.io/CVE-2023-27168/"><link rel="icon" type="image/png" sizes="192x192" href="../img/android-chrome-192x192.png" />
<link rel="icon" type="image/png" sizes="512x512" href="../img/android-chrome-512x512.png" />
<link rel="apple-touch-icon" sizes="180x180" href="../img/apple-touch-icon.png" />
<link rel="shortcut icon" type="image/png" sizes="48x48" href="../img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="../img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="../img/favicon-32x32.png" />


    
 
<title>CVE-2023-27168 - Unrestricted File Upload with Remote Code Execution - Balwurk Technical Exposures</title>


<link href="../css/fontawesome/css/fontawesome.min.css" rel="stylesheet">
<link href="../css/fontawesome/css/solid.min.css" rel="stylesheet">
<link href="../css/normalize.css" rel="stylesheet">
<link href="../css/terminal.css" rel="stylesheet">
<link href="../css/theme.css" rel="stylesheet">
<link href="../css/theme.tile_grid.css" rel="stylesheet">
<link href="../css/theme.footer.css" rel="stylesheet">
<!-- default color palette -->
<link href="../css/palettes/default.css" rel="stylesheet">

<!-- page layout -->
<style>
/* initially set page layout to a one column grid */
.terminal-mkdocs-main-grid {
    display: grid;
    grid-column-gap: 1.4em;
    grid-template-columns: auto;
    grid-template-rows: auto;
}

/*  
*   when side navigation is not hidden, use a two column grid.  
*   if the screen is too narrow, fall back to the initial one column grid layout.
*   in this case the main content will be placed under the navigation panel. 
*/
@media only screen and (min-width: 70em) {
    .terminal-mkdocs-main-grid {
        grid-template-columns: 4fr 9fr;
    }
}</style>



     
    
    

    
    <!-- search css support -->
<link href="../css/search/bootstrap-modal.css" rel="stylesheet">
<!-- search scripts -->
<script>
    var base_url = "..",
    shortcuts = "{}";
</script>
<script src="../js/jquery/jquery-1.10.1.min.js" defer></script>
<script src="../js/bootstrap/bootstrap.min.js" defer></script>
<script src="../js/mkdocs/base.js" defer></script>
    
    
    
    
    <script src="../search/main.js"></script>
    

    
</head>

<body class="terminal"><div class="container">
    <div class="terminal-nav">
        <header class="terminal-logo">
            <div id="mkdocs-terminal-site-name" class="logo terminal-prompt"><a href="https://balwurk.github.io/" class="no-style">Balwurk Technical Exposures</a></div>
        </header>
        
        <nav class="terminal-menu">
            
            <ul vocab="https://schema.org/" typeof="BreadcrumbList">
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href=".." class="menu-item " property="item" typeof="WebPage">
                        <span property="name">Entrypoint</span>
                    </a>
                    <meta property="position" content="0">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="./" class="menu-item active" property="item" typeof="WebPage">
                        <span property="name">CVE-2023-27168 - Unrestricted File Upload with Remote Code Execution</span>
                    </a>
                    <meta property="position" content="1">
                </li>
                
                
                <li property="itemListElement" typeof="ListItem">
                    <a href="../CVE-2023-27172/" class="menu-item " property="item" typeof="WebPage">
                        <span property="name">CVE-2023-27172 Weak JWT secret</span>
                    </a>
                    <meta property="position" content="2">
                </li>
                
                    
                    


<li property="itemListElement" typeof="ListItem">
    <a href="#" class="menu-item" data-toggle="modal" data-target="#mkdocs_search_modal" property="item" typeof="SearchAction">
        <i aria-hidden="true" class="fa fa-search"></i> <span property="name">Search</span>
    </a>
    <meta property="position" content="3">
</li>
                    
            </ul>
            
        </nav>
    </div>
</div>
        
    <div class="container">
        <div class="terminal-mkdocs-main-grid"><aside id="terminal-mkdocs-side-panel"><nav>
  
    <ul class="terminal-mkdocs-side-nav-items">
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="..">Entrypoint</a>
        
    
    
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        <span class="

    terminal-mkdocs-side-nav-item--active">CVE-2023-27168 - Unrestricted File Upload with Remote Code Execution</span>
    
    
    
  </li>
        
          



<li class="terminal-mkdocs-side-nav-li">
    
    
    
        
        
            <a class="

    terminal-mkdocs-side-nav-item" href="../CVE-2023-27172/">CVE-2023-27172 Weak JWT secret</a>
        
    
    
    
  </li>
        
    </ul>
  
</nav><hr>
<nav>
    <ul>
        <li><a href="#cve-2023-27168-unrestricted-file-upload-with-remote-code-execution">CVE-2023-27168 - Unrestricted File Upload with Remote Code Execution</a></li>
        <li><a href="#context">Context</a></li><li><a href="#what-is-write-back">What is Write-Back?</a></li><li><a href="#technical-description">Technical Description</a></li><li><a href="#impact">Impact</a></li><li><a href="#mitigation">Mitigation</a></li><li><a href="#timeline">Timeline</a></li>
    </ul>
</nav>
</aside>
            <main id="terminal-mkdocs-main-content">
<section id="mkdocs-terminal-content">
    <h1 id="cve-2023-27168-unrestricted-file-upload-with-remote-code-execution">CVE-2023-27168 - Unrestricted File Upload with Remote Code Execution</h1>
<h2 id="context">Context</h2>
<p>During an authorised penetration testing assessment conducted on Xpand IT’s Write-Back software, Balwurk’s security team found multiple security vulnerabilities, first disclosed to the customer and then responsibly submitted to the MITRE CVE program.<br />
The discovered vulnerability allows attackers to upload files with dangerous file types and execute code with high integrity/privileges.
This blog post is the final post of a four-part series in which we technically described multiple security vulnerabilities and how they were detected and exploited.</p>
<h2 id="what-is-write-back">What is Write-Back?</h2>
<p>Write-Back is a <strong>Tableau extension</strong> that enables users to submit data directly from a Tableau dashboard to your database, allowing them to implement any actionable use case without leaving the analysis flow.
Write-Back allows users to take the Tableau usage further and implement use cases where you need users to input data, such as forecasting, planning, adding comments, or any actionable process. Includes features like on-premises execution, audit, multiple back-end databases, and integrated authentication.
Before diving into more technical details, we should describe the layout of Write-Back’s high-level back-end architecture:  </p>
<p><strong>Write-Back (Server)</strong>: Tableau extensions are web-based and deployed on a separate application server from the Tableau Server/Cloud. This means that Write-Back should be placed side by side with Tableau, ideally on a separate machine. Users will interact with the Write-Back extension through the Tableau dashboards on different Tableau platforms, i.e., Tableau Desktop, Tableau Server, or even Tableau Cloud.</p>
<p><strong>Write-Back Manager</strong>: Centralizes all configurations and enables platform
administrators to fully control how Write-Back is configured. All of this is done on a web UI. Each Write-Back installation has its own Write-Back manager deployed on the same machine, allowing one to manage that instance.</p>
<h2 id="technical-description">Technical Description</h2>
<p>We consider this vulnerability to be the most complex of all four since it will chain together some of the previously publicated, namely CVE-2023-27170 and CVE-2023-27172. It has been assigned with the ID CVE-2023-27168 and is caused by an unrestricted file type upload security flaw on the Write-Back manager.
The security flaw was initially detected when using the custom logo upload feature on a local installation. It was quickly observed in the web front-end code that there wasn't any file or content type validation in the upload form, allowing us to load and submit a file completely unrelated to an image file.</p>
<p><img alt="Logo Upload HTTP request" src="../img/168_figura1.png" />
<em>Figure 1: Logo Upload HTTP request</em></p>
<p>Receiving the "INVALID_FILE_EXTENSION" error message was not a complete dead end; it just meant there was some kind of validation being done by the server.</p>
<p>Looking at the source code:
<img alt="Valid file extensions." src="../img/168_figura2.png" />
<em>Figure 2: Valid file extensions.</em></p>
<p>Supposedly, the only acceptable extensions are <code>.jpg</code>, <code>.png</code> and <code>.jpeg</code>, but looking at the logos folder, after multiple attempts to upload invalid file types, shows otherwise:</p>
<p><img alt="Logo upload folder." src="../img/168_figura3.png" />
<em>Figure 3: Logo upload folder.</em></p>
<p>It seems the Write-Back Manager, despite answering our malicious upload attempt with an error, actually wrote the files onto the file system.
At this point, we can confirm the existence of an unrestricted file upload vulnerability since it was possible to upload files with a file extension which was not explicitly authorised.<br />
Taking a look at the source code, we can narrow down the cause of this vulnerability to a very simple mistake: the file extension is validated <strong>after</strong> the file has been written to disk, and the error handling routines do not delete the invalid file when the <em>InvalidFileExtentionException</em> is thrown.</p>
<p><img alt="The root cause of CVE-2023-27168." src="../img/168_figura4.png" />
<em>Figure 4: The root cause of CVE-2023-27168.</em></p>
<p>Since this same code pattern was reused on other file upload endpoints, the SSL certificate and JBDC driver upload features were also affected.
Coupled with <strong>CVE-2023-27170</strong>, which allows for directory traversal by introducing special characters in the filename, a malicious user can achieve remote code execution with the same integrity level as the service which is running the web server.</p>
<p>Now, considering the Write-Back Manager and its Apache Tomcat instance are running under <strong>NT Authority/System</strong>, an attacker can take full control of the vulnerable system:</p>
<p><img alt="Webshell upload." src="../img/168_figura5.png" />
<em>Figure 5: Webshell upload.</em></p>
<p>A <code>.jsp</code> webshell was used to demonstrate the exploitation and privilege level acquired:</p>
<p><img alt="OS command execution through jsp webshell." src="../img/168_figura6.png" />
<em>Figure 6: OS command execution through jsp webshell.</em></p>
<p>Chaining everything together with <strong>CVE-2023-27172</strong> allows an <strong>unauthenticated</strong> attacker to take over a vulnerable Write-Back Manager instance.</p>
<h2 id="impact">Impact</h2>
<p>This vulnerability is particularly dangerous, considering how a malicious user can upload a .jsp file into the web root and execute code as SYSTEM on the vulnerable server without needing to authenticate itself.<br />
<strong>CVE ID</strong>: CVE-2023-27168<br />
<strong>CVSS 3.1 Base Score</strong>: 9.8<br />
<strong>CVSS 3.1 Vector</strong>: AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H<br />
<strong>Affected Vendor</strong>: Xpand IT<br />
<strong>Affected Product</strong>: Write-Back<br />
<strong>Affected Version</strong>: Write-Back Manager v2.3.1  </p>
<h2 id="mitigation">Mitigation</h2>
<p>All affected customers should update Write-Back to at least version 4.1.</p>
<h2 id="timeline">Timeline</h2>
<p>9-12-2022 - Vulnerability detected and reported to Write-Back.<br />
22-02-2023 - Vulnerability submitted to MITRE.<br />
10-03-2023 - Vulnerability accepted and CVE-2023-27168 reserved.<br />
12-07-2023 - Official Patch released by Write-Back team.  </p>
<h3 id="credits">Credits</h3>
<p>Bruno Pincho @Balwurk</p>
</section>

            </main>
        </div>
        <hr><footer>
    <div class="terminal-mkdocs-footer-grid">
        <div id="terminal-mkdocs-footer-copyright-info">
             Site built with <a href="http://www.mkdocs.org">MkDocs</a> and <a href="https://github.com/ntno/mkdocs-terminal">Terminal for MkDocs</a>.
        </div>
    </div>
</footer>
    </div>

    
    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="alertdialog" aria-modal="true" aria-labelledby="searchModalLabel">
    <div class="modal-dialog modal-lg" role="search">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">Search</h5>
                <button type="button" class="close btn btn-default btn-ghost" data-dismiss="modal"><span aria-hidden="true">x</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p id="searchInputLabel">Type to start searching</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" aria-labelledby="searchInputLabel" placeholder="" id="mkdocs-search-query" title="Please enter search terms here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No document matches found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    
    
</body>

</html>